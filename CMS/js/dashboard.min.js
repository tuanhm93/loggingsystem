angular.module("RDash", ["ui.bootstrap", "ui.router", "ngCookies", "ngRoute"]);
"use strict";
angular.module("RDash")
    .config(["$stateProvider", "$urlRouterProvider",
        function(t, e) {
            e.otherwise("/dashboard"),
            t.state("dashboard", {
                url: "/dashboard",
                templateUrl: "templates/dashboard.html"
            }).state("listApps", {
                url: "/listApps",
                templateUrl: "templates/listApps.html"
            }).state("modify", {
            	url: "/modify/:token",
            	templateUrl: "templates/appmodify.html"
            }).state("create", {
            	url:"/create",
            	templateUrl: "templates/createapp.html"
            }).state("worker", {
            	url:"/changenumberworkers",
            	templateUrl: "templates/worker.html"
            })
        }
    ]);

var urlService = 'http://localhost:3000';

var dps = [];
var y = 0;
var numberPoint = 100;

function MasterCtrl($scope, e, $http) {
    var g = 992;
    $scope.getWidth = function() {
        return window.innerWidth
    }, $scope.$watch($scope.getWidth, function(o, n) {
        o >= g ? angular.isDefined(e.get("toggle")) ? $scope.toggle = !!e.get("toggle") : $scope.toggle = !0 :$scope.toggle = !1
    }), $scope.toggleSidebar = function() {
        $scope.toggle = !$scope.toggle, e.put("toggle", $scope.toggle)
    }, window.onresize = function() {
        $scope.$apply()
    }
    $scope.loadApps = true;
    $scope.loadWorkers = true;
    $scope.loadLogs = true;
    $scope.loadchart = true;
    $scope.appInf = {
    	page :'Dashboard',
    	breadcrumb :'home / dashboard'
    }

}
angular.module("RDash").controller("MasterCtrl", ["$scope", "$cookieStore", "$http", MasterCtrl]);

function rdLoading() {
    var d = {
        restrict: "AE",
        template: '<div class="loading"><div class="double-bounce1"></div><div class="double-bounce2"></div></div>'
    };
    return d
}
angular.module("RDash").directive("rdLoading", rdLoading);

function rdWidgetBody() {
    var d = {
        requires: "^rdWidget",
        scope: {
            loading: "@?",
            classes: "@?"
        },
        transclude: !0,
        template: '<div class="widget-body" ng-class="classes"><rd-loading ng-show="loading"></rd-loading><div ng-hide="loading" class="widget-content" ng-transclude></div></div>',
        restrict: "E"
    };
    return d
}
angular.module("RDash").directive("rdWidgetBody", rdWidgetBody);

function rdWidgetFooter() {
    var e = {
        requires: "^rdWidget",
        transclude: !0,
        template: '<div class="widget-footer" ng-transclude></div>',
        restrict: "E"
    };
    return e
}
angular.module("RDash").directive("rdWidgetFooter", rdWidgetFooter);

function rdWidgetTitle() {
    var i = {
        requires: "^rdWidget",
        scope: {
            title: "@",
            icon: "@"
        },
        transclude: !0,
        template: '<div class="widget-header"><div class="row"><div class="pull-left"><i class="fa" ng-class="icon"></i> {{title}} </div><div class="pull-right col-xs-6 col-sm-4" ng-transclude></div></div></div>',
        restrict: "E"
    };
    return i
}
angular.module("RDash").directive("rdWidgetHeader", rdWidgetTitle);

function rdWidget() {
    var d = {
        transclude: !0,
        template: '<div class="widget" ng-transclude></div>',
        restrict: "EA"
    };
    return d
}
angular.module("RDash").directive("rdWidget", rdWidget);


angular.module("RDash").controller('DashboardCtrl', function($scope, $http) {
	$scope.appInf.page = 'Dashboard';
    $scope.appInf.breadcrumb = 'home/dashboard';

	 var getNumberApps = function(){
    	$http.get(urlService+'/numberApps').
    		success(function(data){
    			if(data.success){
	    			$scope.loadApps = false;
	    			$scope.apps = data.apps;	
    			}
    		});
    }

    setInterval(getNumberApps, 2000);

    var getWorkersInf = function(){
		$http.get(urlService+'/workerInf').
    		success(function(data){
    			if(data.success){
	    			$scope.loadWorkers = false;
	    			$scope.loadLogs = false;
	    			$scope.workers = data.workers;
	    			$scope.loadchart = false;
	    			$scope.chart = true;
	    			$scope.logs = data.logs;
	    			y = y + 2;
	    			dps.push({y: $scope.logs, x: y});	
	    			if(dps.length > numberPoint){
	    				dps.shift();
	    			}
    			}
    		});
    }
    setInterval(getWorkersInf, 2000);
});

angular.module("RDash").controller('ListAppsCtrl', function($scope, $http, $window) {
	$scope.appInf.page = 'List apps';
    $scope.appInf.breadcrumb = 'home/listApps';
	$scope.listApps = [];
    $http.get(urlService+'/getListApps')
    	.success(function(data){
    		console.log(data);
    		if(data.success){
    			$scope.listApps = data.listApp;
    		}
    	});

    $scope.delete = function(index){
    	var confirm = $window.confirm("Are you sure to delete '"+$scope.listApps[index].name+"'");
    	if(confirm){
    		$http.get(urlService+'/deleteApp?_token='+$scope.listApps[index]._id)
	    		.then(function(data){
	    			if(data.data.success){
	    				$scope.listApps.splice(index, 1);
	    			}else{
	    				
	    			}
	    		}, function(err){

	    		});
    	}
    }
});

angular.module("RDash").controller('ModifyAppCtrl', function($scope, $http, $stateParams) {
	$scope.appInf.page = 'Modify an app';
    $scope.appInf.breadcrumb = 'home/modify';
    $http.get(urlService+'/getApp?_token='+$stateParams.token)
    	.success(function(data){
    		console.log(data);
    		if(data.success){
    			$scope.old = data.app[0].expireTime;
    			$scope.app = data.app[0];
    		}
    	});
    $scope.loadupdate = false;
    $scope.button = true;
    $scope.update = function(){
        $scope.success = false;
        $scope.faild = false;
    	$scope.loadupdate = true;
    	$scope.button = false;
    	$http.get(urlService+'/changeExpireTime?_token='+$stateParams.token+'&expireTime='+$scope.app.expireTime)
    		.then(function(data){
                console.log(data);
    			if(data.data.success){
    				$scope.old = $scope.app.expireTime;
                    $scope.success = true;
                    $scope.faild = false;
    			}else{
    				$scope.app.expireTime = $scope.old;
                    $scope.success = false;
                    $scope.faild = true;
    			}
    			$scope.loadupdate = false;
    			$scope.button = true;
    		
    		}, function(err){
    			$scope.app.expireTime = $scope.old;
    			$scope.loadupdate = false;
    			$scope.button = true;
    			$scope.faild = true;
    			$scope.success = false;
    		});
    }
});

angular.module("RDash").controller('CreateAppCtrl', function($scope, $http) {
    $scope.appInf.page = 'Create a new app';
    $scope.appInf.breadcrumb = 'home/create';

    $scope.app = {
    	_token: '',
    	name: ''
    }

    $scope.button = true;

    $scope.create = function(){
    	$scope.button = false;
    	$scope.loadcreate = true;
    	$scope.success = false;
    	$scope.faild = false;
    	if($scope.app.name != ''){
    		$http.post(urlService+'/addApp', {name: $scope.app.name})
    			.then(function(data){
    				console.log(data);
    				if(data.data.success){
    					$scope.app._token = data.data._token;
    					$scope.success = true;
    				}else{
    					$scope.faild = true;
    				}
    				$scope.button = true;
    				$scope.loadcreate = false;
    			}, function(err){
					$scope.button = true;
    				$scope.loadcreate = false;
    			});
    	}else{
    		$scope.faild = true;
    		$scope.button = true;
    		$scope.loadcreate = false;
    	}
    }
});

angular.module("RDash").controller('WorkerCtrl', function($scope, $http) {
    $scope.appInf.page = 'Workers';
    $scope.appInf.breadcrumb = 'home/changenumberworkers';
    $scope.numberWorkers;
    $scope.button = true;
    var getWorkersInf = function(){
		$http.get(urlService+'/workerInf').
    		success(function(data){
    			if(data.success){
	    			$scope.loadWorkers = false;
	    			$scope.loadLogs = false;
	    			$scope.workers = data.workers;

	    			$scope.logs = data.logs;
    			}
    		});
    }
    setInterval(getWorkersInf, 2000);

    $scope.change = function(){
        console.log('haha111');
    	$scope.button = false;
    	$scope.loadchange = true;
    	$scope.success = false;
    	$scope.faild = false;
    	$http.get(urlService+"/changeNumberWorkers?numberWorkers="+$scope.numberWorkers)
    		.then(function(data){
                console.log('haha');
    			if(data.data.success){
    				$scope.success = true;
    			}else{
    				$scope.faild = true;
    			}
    			$scope.loadchange = false;
    			$scope.button = true;
    		}, function(err){
    			$scope.loadchange = false;
    			$scope.button = true;
    			$scope.faild = true;
    		});
    }
});


